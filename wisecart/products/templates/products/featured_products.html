{% if featured_products %}
<section class="py-8 px-4 max-w-7xl mx-auto">
    <!-- Section Header -->
    <div class="text-center mb-6">
        <h2 id="featured-products" class="text-2xl font-bold text-gray-900 mb-2">Featured Products</h2>
        <p class="text-gray-600">Discover amazing deals on trending products</p>
    </div>

    <!-- Products Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for featured in featured_products %}
        <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden group">
            <!-- Product Image Container -->
            <div class="relative h-48 bg-gray-50 flex items-center justify-center p-4">
                {% if featured.image %}
                    <img 
                        src="{{ featured.image.url }}" 
                        alt="{{ featured.product.name }}"
                        class="max-w-full max-h-full object-contain transition-transform duration-300 group-hover:scale-105"
                        loading="lazy"
                    >
                {% elif featured.product.image_src %}
                    <img 
                        src="{{ featured.product.image_src }}" 
                        alt="{{ featured.product.name }}"
                        class="max-w-full max-h-full object-contain transition-transform duration-300 group-hover:scale-105"
                        loading="lazy"
                    >
                {% else %}
                    <!-- Fallback for missing images -->
                    <div class="w-16 h-16 text-gray-400">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                {% endif %}
                
                <!-- Price Badge -->
                {% if featured.product.price %}
                    <div class="absolute top-3 right-3">
                        <span class="bg-blue-600 text-white font-semibold text-sm px-3 py-1.5 rounded-full shadow-lg">
                            ৳{{ featured.product.price }}
                        </span>
                    </div>
                {% endif %}
                
                <!-- Store Badge -->
                <div class="absolute bottom-3 left-3">
                    <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded-full opacity-90">
                        {{ featured.product.store.name }}
                    </span>
                </div>
            </div>

            <!-- Product Details -->
            <div class="p-4">
                <!-- Title -->
                <h3 class="text-sm font-semibold text-gray-900 line-clamp-2 mb-2 group-hover:text-blue-600 transition-colors duration-200">
                    {{ featured.product.name }}
                </h3>

                <!-- Rating and Stock Status -->
                <div class="flex items-center justify-between mb-3">
                    {% if featured.product.rating %}
                        <div class="flex items-center">
                            <div class="flex text-yellow-400 mr-1">
                                <svg class="w-3 h-3 fill-current" viewBox="0 0 24 24">
                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600">{{ featured.product.rating }}</span>
                        </div>
                    {% endif %}
                    
                    <!-- Stock Status -->
                    <span class="text-xs px-2 py-1 rounded-full {% if featured.product.stock %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                        {% if featured.product.stock %}In Stock{% else %}Out of Stock{% endif %}
                    </span>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2">
                    <button onclick="addFeaturedToCompare({{ featured.product.id }})" 
                            class="compare-featured-btn flex-1 inline-flex justify-center items-center px-3 py-2 text-xs font-semibold rounded border border-gray-200 hover:bg-gray-50 transition-colors duration-200"
                            data-featured-product-id="{{ featured.product.id }}">
                        Compare
                    </button>
                    <a 
                        href="{% url 'products:product_detail' featured.product.store.name featured.product.url %}"
                        class="flex-1 inline-flex justify-center items-center px-3 py-2 text-xs text-gray-700 rounded border border-gray-200 hover:bg-gray-50 transition-colors duration-200"
                    >
                        Details
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Featured Products Comparison Floating Button -->
<div id="featured-comparison-float" class="fixed bottom-6 right-6 z-50" style="display: none;">
    <a href="{% url 'comparison:compare' %}" 
       class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all duration-200 hover:scale-105">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        Compare (<span id="featured-compare-count">0</span>)
    </a>
</div>

<script>
let featuredCompareCount = 0;

// Load initial comparison count for featured products
fetch('{% url "comparison:count" %}')
    .then(response => response.json())
    .then(data => {
        updateFeaturedCompareUI(data.count);
    })
    .catch(error => console.error('Error loading featured compare count:', error));

function addFeaturedToCompare(productId) {
    // Update button to show loading state
    const button = document.querySelector(`[data-featured-product-id="${productId}"]`);
    if (button) {
        button.textContent = 'Adding...';
        button.style.backgroundColor = '#f59e0b';
        button.disabled = true;
    }
    
    fetch('{% url "comparison:add_featured" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            'product_id': productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateFeaturedCompareUI(data.count);
            showFeaturedMessage('Product added to comparison successfully!', 'success');
            
            // Update button state
            if (button) {
                button.textContent = 'Added ✓';
                button.style.backgroundColor = '#10b981';
                button.disabled = true;
                button.onclick = null;
            }
        } else {
            showFeaturedMessage(data.message, 'error');
            
            // Reset button on error
            if (button) {
                button.textContent = 'Compare';
                button.style.backgroundColor = '';
                button.disabled = false;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFeaturedMessage('An error occurred while adding to comparison.', 'error');
        
        // Reset button on error
        if (button) {
            button.textContent = 'Compare';
            button.style.backgroundColor = '';
            button.disabled = false;
        }
    });
}

function updateFeaturedCompareUI(count) {
    featuredCompareCount = count;
    document.getElementById('featured-compare-count').textContent = count;
    
    const floatDiv = document.getElementById('featured-comparison-float');
    if (count > 0) {
        floatDiv.style.display = 'block';
    } else {
        floatDiv.style.display = 'none';
    }
}

function showFeaturedMessage(message, type, duration = 3000) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
        type === 'info' ? 'bg-blue-100 text-blue-800 border border-blue-200' :
        'bg-red-100 text-red-800 border border-red-200'
    }`;
    
    // Add icon based on type
    const icon = type === 'success' ? '✓' : type === 'info' ? 'ℹ' : '✗';
    toast.innerHTML = `<span class="font-semibold">${icon}</span> ${message}`;
    
    document.body.appendChild(toast);
    
    // Remove after specified duration
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, duration);
}
</script>
{% endif %}